<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Com.On ì¶”ì²œ ê²°ê³¼</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
</head>
<body>
  <div class="navbar">
    <div class="navbar-left">
      <a href="/" class="navbar-logo">
        <img
          src="https://velog.velcdn.com/images/gogogi313/post/21e72a8f-67e3-43c4-9395-8c8e6e5faa18/image.png"
          alt="íŒ€ ë¡œê³ "
          class="logo-img"
        />
      </a>
      <a href="/" class="logo-title">Com.On</a> <!-- âœ… ë³€ê²½ëœ ë¶€ë¶„ -->
    </div>
    <span class="navbar-title">ë§ì¶¤í˜• ì¶”ì²œ ë³´ê³ ì„œ</span>
  </div>
  
  <p id="queryText"></h2>
  <p id="queryExplanation"></p>
  <div id="product-container"></div>
  <div id="refine-question"></div>
  <div id="followup-search"></div>

  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
      var f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true; j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-MZHQSKG5');

    const params = new URLSearchParams(window.location.search);
    const query = params.get("query");

    async function fetchField(name, field) {
      try {
        const res = await fetch(`https://n8n.1000.school/webhook/api/get_${field}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: name })
        });
        return await res.text();
      } catch (err) {
        console.warn(`âŒ ${field} ì˜¤ë¥˜:`, err);
        return 'ì •ë³´ ì—†ìŒ';
      }
    }

    async function getProductDetail(name) {
      const fields = ['highlight', 'review', 'feature', 'link', 'price', 'weight', 'score'];
      const fetches = fields.map(field => fetchField(name, field));
      const values = await Promise.all(fetches);
      const detail = { name };
      fields.forEach((f, i) => detail[f] = values[i]);
      return detail;
    }

    async function fetchRefineOptions(question) {
      try {
        const res = await fetch('https://n8n.1000.school/webhook/api/get_refine_questions', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });
        return await res.json();
      } catch (err) {
        console.warn('âŒ refine JSON íŒŒì‹± ì˜¤ë¥˜:', err);
        return [];
      }
    }

    function renderStars(score) {
      const s = parseFloat(score);
      const full = Math.floor(s);
      const half = s - full >= 0.5;
      return 'â˜…'.repeat(full) + (half ? 'â˜†' : '') + 'â˜†'.repeat(5 - full - (half ? 1 : 0));
    }

    function renderProduct(p) {
      return `
        <div class="product">
          <div class="product-header">
            <div class="image-slider">
              <img src="https://via.placeholder.com/100" alt="${p.name}">
            </div>
            <div class="product-info">
              <h2>${p.name}</h2>
              <p><strong>ê°€ê²©:</strong> ${p.price}</p>
              <p><strong>ë¬´ê²Œ:</strong> ${p.weight}</p>
              <p><strong>ì£¼ìš” íŠ¹ì§•:</strong> ${p.feature}</p>
              <div class="review-box">
                <span class="stars">${renderStars(p.score)}</span>
                <span class="score">${p.score} / 5</span>
                <p class="quote">â€œ${p.review}â€</p>
              </div>
            </div>
          </div>
          <p class="highlight">${p.highlight}</p>
          <a class="buy-button" href="${p.link}" target="_blank">ğŸ”— ìƒì„¸í˜ì´ì§€ì—ì„œ ìì„¸íˆ ë³´ê¸°</a>
        </div>`;
    }
	
	function insertFeedbackSection() {
	  const section = document.createElement("div");
	  section.style.marginTop = "40px";
	  section.style.padding = "20px";
	  section.style.textAlign = "center";
	  section.style.fontSize = "0.95rem";
	  section.style.color = "#555";

	  section.innerHTML = `
		<p>ğŸ“¬ ì„œë¹„ìŠ¤ì— ëŒ€í•œ í”¼ë“œë°±ì´ ìˆìœ¼ì‹ ê°€ìš”?<br>
		ì•„ë˜ ì˜¤í”ˆì±„íŒ…ë°©ì„ í†µí•´ ì–¸ì œë“ ì§€<br>ì˜ê²¬ì„ ë‚˜ëˆ ì£¼ì„¸ìš”!</p>
		
		<a href="https://open.kakao.com/o/glqkU8zh" target="_blank" style="display:inline-block; margin: 10px; font-weight: bold; color: #0068ff; text-decoration: none;">
		  ğŸ‘‰ ì˜¤í”ˆì±„íŒ…ë°© ë°”ë¡œê°€ê¸°
		</a>
		
		<div style="margin-top: 15px;">
		  <img src="https://velog.velcdn.com/images/gogogi313/post/35554d94-8b43-444a-8dc9-f31d5a168065/image.png" 
			   alt="ì˜¤í”ˆì±„íŒ…ë°© QRì½”ë“œ" 
			   style="width: 130px; height: 130px; border: 1px solid #eee; border-radius: 8px;">
		  <p style="margin-top: 8px; font-size: 0.85rem; color: #999;">QRë¡œë„ ì°¸ì—¬í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”</p>
		</div>
	  `;

	  document.body.appendChild(section);
	}
	
	function startFancyLoading() {
	  const container = document.getElementById("product-container");
	  container.innerHTML = `
		<div id="loading-visual" class="loading-visual">
		  <div class="doc-count">
			ğŸ“„ <span id="doc-count">0</span>ê°œì˜ ë¬¸ì„œë¥¼ íƒìƒ‰ ì¤‘ì…ë‹ˆë‹¤...
		  </div>
		  <div class="doc-icons">
			<span class="doc-icon">ğŸ“„</span>
			<span class="doc-icon">ğŸ—‚ï¸</span>
			<span class="doc-icon">ğŸ“</span>
			<span class="doc-icon">ğŸ“ƒ</span>
			<span class="doc-icon">ğŸ“„</span>
			<span class="doc-icon">ğŸ“„</span>
			<span class="doc-icon">ğŸ“„</span>
		  </div>
		</div>
	  `;

	  let count = 0;
	  const countSpan = document.getElementById("doc-count");
	  const docText = document.querySelector(".doc-count");

	  // 80 ~ 120 ì‚¬ì´ì˜ ëœë¤ ëª©í‘œê°’ ì„¤ì •
	  const targetCount = Math.floor(Math.random() * 41) + 80;

	  const interval = setInterval(() => {
		const increment = Math.floor(Math.random() * 4) + 2;
		count += increment;

		if (count >= targetCount) {
		  clearInterval(interval);
		  countSpan.textContent = `ì•½ ${targetCount}`;
		  docText.innerHTML = `ğŸ“„ ì•½ ${targetCount}ê°œì˜ ë¬¸ì„œë¥¼ íƒìƒ‰í–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...`;
		} else {
		  countSpan.textContent = count;
		}
	  }, 350);

	  return () => clearInterval(interval);
	}
	
	function renderFollowupSearchBox() {
	  if (!query) return;

	  const container = document.getElementById("followup-search");
	  if (!container) return;

	  container.innerHTML = `
	  <div class="followup-box">
		<p class="description">
		  ğŸ” ë” ì›í•˜ëŠ” ì¡°ê±´ì´ ìˆìœ¼ì‹ ê°€ìš”?<br>
		  ì¶”ê°€ í‚¤ì›Œë“œë¥¼ ì´ì–´ì„œ ì…ë ¥í•´ ë³´ì„¸ìš”!
		</p>
		<form class="search-box" onsubmit="followupSearch(); return false;">
		  <input
			type="text"
			id="followupInput"
			placeholder="ì˜ˆ: ë§ˆìŒì´ ë°”ë€Œì—ˆì–´!"
		  />
		  <button type="submit">ê²€ìƒ‰</button>
		</form>
	  </div>
	`;
	}
	
	function followupSearch() {
	  const extra = document.getElementById("followupInput").value.trim();
	  if (!extra) return;

	  const newQuery = `${query} ${extra}`.trim();
	  location.href = `/search?query=${encodeURIComponent(newQuery)}`;
	}
	
	function fillExample(text) {
		const explainBox = document.getElementById("queryExplanation");

		let index = 0;
		const typingSpeed = 30; // ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ì†ë„

		explainBox.textContent = ''; // ì´ˆê¸°í™”

		const typingInterval = setInterval(() => {
		  if (index < text.length) {
			explainBox.textContent += text.charAt(index);
			index++;
		  } else {
			clearInterval(typingInterval);
		  }
		}, typingSpeed);
	}
	
	async function getValidImageURLs(query, max = 1) {
	  try {
		const res = await fetch("https://n8n.1000.school/webhook/naver-image", {
		  method: "POST",
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify({ query })
		});
		const items = await res.json();
		for (const item of items) {
		  const isValid = await validateImage(item.thumbnail);
		  if (isValid) return [item.thumbnail]; // âœ… í•œ ì¥ë§Œ ë¦¬í„´
		}
	  } catch (err) {
		console.error("ì´ë¯¸ì§€ ì˜¤ë¥˜:", err);
	  }
	  return [];
	}



	// ì´ë¯¸ì§€ URLì´ ì‹¤ì œë¡œ í‘œì‹œ ê°€ëŠ¥í•œì§€ ê²€ì‚¬
	function validateImage(url) {
	  return new Promise((resolve) => {
		const img = new Image();
		img.onload = () => resolve(true);
		img.onerror = () => resolve(false);
		img.src = url;
	  });
	}

    async function renderPage() {
      const queryBox = document.getElementById("queryText");
      const explanationBox = document.getElementById("queryExplanation");
      const container = document.getElementById("product-container");
      const refineDiv = document.getElementById("refine-question");
      if (!query) {
        queryBox.innerText = "ì¡°ê±´ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”.";
        return;
      }

      queryBox.innerText = `ğŸ’¬ â€œ${query}â€ ì¡°ê±´ì— ë§ëŠ” ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.`;
      startFancyLoading();
	  insertFeedbackSection();

      try {
        const [productNameRes, introRes, refineJson] = await Promise.all([
          fetch('https://n8n.1000.school/webhook/api/get_product_name', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: query })
          }),
          fetch('https://n8n.1000.school/webhook/api/get_intro', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: query })
          }),
          fetchRefineOptions(query)
        ]);

        const productNameText = await productNameRes.text();
        const introText = await introRes.text();
        const productNames = productNameText.trim().split('\n').filter(Boolean);
		fillExample(introText);

        const productDetails = await Promise.all(productNames.map(getProductDetail));
        container.innerHTML = "";
        for (const p of productDetails) {
		  container.insertAdjacentHTML("beforeend", renderProduct(p));
		  const productEls = container.querySelectorAll(".product");
		  const latestProduct = productEls[productEls.length - 1];
		  const imageSlider = latestProduct.querySelector(".image-slider");

		  if (imageSlider && p.name) {
			const images = await getValidImageURLs(p.name, 1);
			if (images.length > 0) {
			  imageSlider.innerHTML = `
				<img src="${images[0]}" class="slide active" alt="${p.name} ì´ë¯¸ì§€">`;
			}
		  }
		}


        if (refineJson.length > 0) {
		  let html = `
			<p class="refine-guidance">
			  ğŸ”§ ì¡°ê¸ˆ ë” êµ¬ì²´ì ì¸ ì¡°ê±´ì„ ì„ íƒí•´ ë³´ì„¸ìš”!<br>
			  ì•„ë˜ ì§ˆë¬¸ì„ í†µí•´ <strong>ë‚˜ì—ê²Œ ê¼­ ë§ëŠ” ì œí’ˆ</strong>ì„ ì¶”ì²œë°›ì„ ìˆ˜ ìˆì–´ìš” ğŸ™Œ
			</p>
		  `;

		  refineJson.forEach(item => {
			html += `
			  <div class="refine-block">
				<p class="refine-title">${item.question}</p>
				<div class="refine-options">
				  ${item.options.map(opt => `
					<span class="refine-option" data-query="${opt}">${opt}</span>
				  `).join('')}
				</div>
			  </div>
			`;
		  });

		  refineDiv.innerHTML = html;
		}

		renderFollowupSearchBox();
      } catch (error) {
        container.innerHTML = `<p>âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
      }
    }

    document.addEventListener("click", (e) => {
	  if (e.target.classList.contains("refine-option")) {
		const selected = e.target.getAttribute("data-query");
		const input = document.getElementById("followupInput");
		if (!input) return;
		input.value = `${input.value} ${selected}`.trim(); // ì´ì–´ì„œ ì…ë ¥
		input.focus();
	  }
	});


    document.addEventListener("DOMContentLoaded", renderPage);
  </script>
</body>
</html>
