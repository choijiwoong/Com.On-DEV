<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì œí’ˆ ì¶”ì²œ ì‹¤í—˜</title>
  <style>
    .product { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; border-radius: 10px; }
    .product-header { display: flex; gap: 1rem; }
    .product-info h2 { margin: 0; }
    .buy-button { display: inline-block; margin-top: 0.5rem; color: blue; text-decoration: underline; }
    img { width: 100px; height: auto; }
    .refine-block { border: 2px dashed #999; padding: 1rem; margin-top: 1rem; border-radius: 8px; }
    .refine-title { font-weight: bold; margin-bottom: 0.5rem; }
    .refine-options button { margin: 0.2rem; padding: 0.4rem 0.8rem; border-radius: 6px; border: none; background: #eef; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ì œí’ˆ ì¶”ì²œ ì‹¤í—˜</h2>
  <form id="questionForm">
    <label for="question">ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:</label><br>
    <input type="text" id="question" name="question" required style="width: 300px;">
    <button type="submit">ì œì¶œ</button>
  </form>

  <p id="queryExplanation">ì•„ë˜ëŠ” ì¶”ì²œëœ ì œí’ˆì…ë‹ˆë‹¤:</p>
  <div id="result">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="refine-question" style="display: none;"></div>

  <script>
    async function fetchField(name, field) {
      try {
        const res = await fetch(`https://n8n.1000.school/webhook/api/get_${field}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: name })
        });
        const raw = await res.text();
        console.log(`ğŸ“… ${field} ì‘ë‹µ ì›ë¬¸:`, raw);
        return raw;
      } catch (err) {
        console.warn(`âŒ ${field} ì˜¤ë¥˜:`, err);
        return 'ì •ë³´ ì—†ìŒ';
      }
    }

    async function getProductDetail(name) {
      const fields = ['highlight', 'review', 'feature', 'link', 'price', 'weight', 'score' ];
      const fetches = fields.map(field => fetchField(name, field));
      const values = await Promise.all(fetches);
      const detail = { name };
      fields.forEach((f, i) => detail[f] = values[i]);
      return detail;
    }

    async function fetchRefineOptions(question) {
	  const res = await fetch('https://n8n.1000.school/webhook/api/get_refine_questions', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ question })
	  });
	  const text = await res.text();
	  try {
		return JSON.parse(text);
	  } catch (err) {
		console.warn('âŒ refine JSON íŒŒì‹± ì˜¤ë¥˜:', err, text);
		return [];
	  }
	}


    document.getElementById('questionForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const question = document.getElementById('question').value;
      const resultDiv = document.getElementById('result');
      const refineDiv = document.getElementById('refine-question');
      resultDiv.innerHTML = 'ì¶”ì²œ ì œí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
      refineDiv.style.display = 'none';

      try {
        const [productNameRes, introRes, refineJson] = await Promise.all([
          fetch('https://n8n.1000.school/webhook/api/get_product_name', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question })
          }),
          fetch('https://n8n.1000.school/webhook/api/get_intro', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question })
          }),
          fetchRefineOptions(question)
        ]);

        const productNameText = await productNameRes.text();
        const introText = await introRes.text();
        const productNames = productNameText.trim().split('\n').filter(Boolean);

        const productDetails = await Promise.all(productNames.map(getProductDetail));

        resultDiv.innerHTML = `<div class="intro"><p><strong>ì¶”ì²œ ì´ìœ :</strong> ${introText}</p></div>`;
        for (const p of productDetails) {
          const html = `
            <div class="product">
              <div class="product-header">
                <div class="image-slider">
                  <img src="${p.image || ''}" alt="${p.name}">
                </div>
                <div class="product-info">
                  <h2>ğŸ›™ï¸ ${p.name}</h2>
                  <p><strong>ê°€ê²©:</strong> ${p.price || 'ì •ë³´ ì—†ìŒ'}</p>
                  <p><strong>ë¬´ê²Œ:</strong> ${p.weight || 'ì •ë³´ ì—†ìŒ'}</p>
                  <p><strong>ì£¼ìš” íŠ¹ì§•:</strong> ${p.feature || 'ì •ë³´ ì—†ìŒ'}</p>
                  <div class="review-box">
                    <span class="stars">â­â­â­â­â˜†</span>
                    <span class="score">${p.score || 'ì •ë³´ ì—†ìŒ'} / 5</span>
                    <p class="quote">â€œ${p.review || 'ì •ë³´ ì—†ìŒ'}â€</p>
                  </div>
                </div>
              </div>
              <p class="highlight">${p.highlight || 'ì •ë³´ ì—†ìŒ'}</p>
              <a class="buy-button" href="https://www.coupang.com/np/search?component=&q=${p.name}&channel=user" target="_blank" rel="noopener noreferrer">ğŸ”— ìƒì„¸í˜ì´ì§€ì—ì„œ ìì„¸íˆ ë³´ê¸°</a>
            </div>`;
          resultDiv.innerHTML += html;
        }

        if (refineJson.length > 0) {
          let refineHTML = '<div class="refine-block"><div class="refine-title">ğŸ” ì§ˆë¬¸ì„ ë” êµ¬ì²´í™”í•´ë³´ì‹œê² ì–´ìš”?</div>';
          refineJson.forEach(item => {
            refineHTML += `<p>${item.question}</p>`;
            item.options.forEach(opt => {
              refineHTML += `<button class="refine-option" data-query="${opt}">${opt}</button>`;
            });
          });
          refineHTML += '</div>';
          refineDiv.innerHTML = refineHTML;
          refineDiv.style.display = 'block';
        }

      } catch (error) {
        resultDiv.innerHTML = 'âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
      }
    });

    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('refine-option')) {
        const selected = e.target.getAttribute('data-query');
        const input = document.getElementById('question');
        input.value += ' ' + selected;
        document.getElementById('refine-question').style.display = 'none';
        document.getElementById('questionForm').dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>
